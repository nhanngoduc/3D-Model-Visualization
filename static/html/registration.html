<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration - Medical Data Viewer</title>
    <link rel="stylesheet" href="../css/style.css?v=2">
    <link rel="stylesheet" href="../css/registration.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="icon">üè•</span>
                    Medical Data Viewer
                </h1>
                <div class="header-nav">
                    <a href="../index.html" class="nav-link">Viewer</a>
                    <a href="registration.html" class="nav-link active">Registration</a>
                </div>
                <div class="header-info" id="headerInfo">
                    <span class="status-indicator"></span>
                    <span class="status-text">Registration Mode</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- REG-01: Model Selection Panel -->
                <div id="modelSelectionPanel" class="sidebar-section">
                    <h2 class="section-title">Model Selection</h2>

                    <!-- Source Model -->
                    <div class="model-selector">
                        <label class="selector-label">Source Model (Movable)</label>
                        <small class="selector-hint">Will be aligned to target</small>

                        <label for="sourcePatient" class="mini-label">Patient</label>
                        <select id="sourcePatient" class="custom-select">
                            <option value="">-- Select Patient --</option>
                        </select>

                        <label for="sourceDataType" class="mini-label">Data Type</label>
                        <select id="sourceDataType" class="custom-select" disabled>
                            <option value="">-- Select Data Type --</option>
                        </select>

                        <label for="sourceModel" class="mini-label">Model</label>
                        <select id="sourceModel" class="custom-select" disabled>
                            <option value="">-- Select Model --</option>
                        </select>
                    </div>

                    <!-- Swap Button -->
                    <button id="swapModelsBtn" class="btn btn-secondary btn-icon" title="Swap Source and Target">
                        <span class="btn-icon-symbol">‚áÑ</span>
                        Swap Models
                    </button>

                    <!-- Target Model -->
                    <div class="model-selector">
                        <label class="selector-label">Target Model (Fixed)</label>
                        <small class="selector-hint">Reference (will not move)</small>

                        <label for="targetPatient" class="mini-label">Patient</label>
                        <select id="targetPatient" class="custom-select">
                            <option value="">-- Select Patient --</option>
                        </select>

                        <label for="targetDataType" class="mini-label">Data Type</label>
                        <select id="targetDataType" class="custom-select" disabled>
                            <option value="">-- Select Data Type --</option>
                        </select>

                        <label for="targetModel" class="mini-label">Model</label>
                        <select id="targetModel" class="custom-select" disabled>
                            <option value="">-- Select Model --</option>
                        </select>
                    </div>

                    <!-- Direction Indicator -->
                    <div class="direction-indicator" id="directionIndicator" style="display: none;">
                        <span class="direction-arrow">Source</span>
                        <span class="direction-arrow-symbol">‚Üí</span>
                        <span class="direction-arrow">Target</span>
                    </div>

                    <!-- Validation Message -->
                    <div id="validationMessage" class="validation-message" style="display: none;"></div>

                    <!-- Next Button -->
                    <button id="proceedBtn" class="btn btn-primary" disabled>
                        Load Models & Register ‚Üí
                    </button>
                </div>

                <!-- REG-02: Viewer Controls Panel -->
                <div id="viewerControlsPanel" class="sidebar-section" style="display: none;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;">Viewer Controls</h2>
                        <button id="backToSelectionBtn" class="btn btn-small" title="Back to Selection">‚Üê Back</button>
                    </div>

                    <!-- Visibility Toggles -->
                    <div class="control-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="toggleSource" checked>
                            <span>Show Source</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="toggleTarget" checked>
                            <span>Show Target</span>
                        </label>
                    </div>

                    <!-- Opacity Sliders -->
                    <div class="control-group">
                        <div class="slider-group">
                            <label for="sourceOpacity">Source Opacity</label>
                            <div class="slider-container">
                                <input type="range" id="sourceOpacity" min="0" max="100" value="100" class="slider">
                                <span id="sourceOpacityValue" class="slider-value">100%</span>
                            </div>
                        </div>

                        <div class="slider-group">
                            <label for="targetOpacity">Target Opacity</label>
                            <div class="slider-container">
                                <input type="range" id="targetOpacity" min="0" max="100" value="100" class="slider">
                                <span id="targetOpacityValue" class="slider-value">100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Model Rotation Controls -->
                    <div class="control-group rotation-controls">
                        <h3 class="control-subtitle">Model Rotation</h3>

                        <!-- Source Rotation -->
                        <div class="rotation-model-group">
                            <label class="rotation-label">Source Model</label>
                            <div class="rotation-buttons">
                                <button class="btn-rotation" id="sourceRotateXPos" title="Rotate X+">X+</button>
                                <button class="btn-rotation" id="sourceRotateXNeg" title="Rotate X-">X-</button>
                                <button class="btn-rotation" id="sourceRotateYPos" title="Rotate Y+">Y+</button>
                                <button class="btn-rotation" id="sourceRotateYNeg" title="Rotate Y-">Y-</button>
                                <button class="btn-rotation" id="sourceRotateZPos" title="Rotate Z+">Z+</button>
                                <button class="btn-rotation" id="sourceRotateZNeg" title="Rotate Z-">Z-</button>
                            </div>
                            <button class="btn btn-small" id="sourceResetRotation">Reset Rotation</button>
                        </div>

                        <!-- Target Rotation -->
                        <div class="rotation-model-group">
                            <label class="rotation-label">Target Model</label>
                            <div class="rotation-buttons">
                                <button class="btn-rotation" id="targetRotateXPos" title="Rotate X+">X+</button>
                                <button class="btn-rotation" id="targetRotateXNeg" title="Rotate X-">X-</button>
                                <button class="btn-rotation" id="targetRotateYPos" title="Rotate Y+">Y+</button>
                                <button class="btn-rotation" id="targetRotateYNeg" title="Rotate Y-">Y-</button>
                                <button class="btn-rotation" id="targetRotateZPos" title="Rotate Z+">Z+</button>
                                <button class="btn-rotation" id="targetRotateZNeg" title="Rotate Z-">Z-</button>
                            </div>
                            <button class="btn btn-small" id="targetResetRotation">Reset Rotation</button>
                        </div>
                    </div>

                    <!-- Camera Presets -->
                    <div class="control-group">
                        <label for="cameraPreset">Camera Preset</label>
                        <select id="cameraPreset" class="custom-select">
                            <option value="isometric">Isometric</option>
                            <option value="front">Front View</option>
                            <option value="top">Top View</option>
                            <option value="left">Left View</option>
                            <option value="fitAll">Fit All</option>
                        </select>
                    </div>

                    <!-- Manual Registration -->
                    <button id="manualRegBtn" class="btn btn-secondary" disabled>
                        Manual Registration (4-point)
                    </button>

                    <!-- Next Step -->
                    <button id="continueRegBtn" class="btn btn-primary">
                        Continue to Registration ‚Üí
                    </button>
                </div>

                <!-- Registration Result Overlay Controls -->
                <div id="overlayControlsPanel" class="sidebar-section" style="display: none;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;">Registration Result</h2>
                        <button id="backToSplitViewBtn" class="btn btn-small" title="Back to Split View">‚Üê Back</button>
                    </div>

                    <!-- Result Info -->
                    <div id="registrationResultInfo"
                        style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 16px; color: #4caf50; font-size: 0.9rem;">
                        <strong>‚úì Registration Complete</strong>
                        <p style="margin: 8px 0 0 0; font-size: 0.85rem;">Source model is now aligned with target. You
                            can rotate and inspect the result below.</p>
                    </div>

                    <!-- Visibility Toggles -->
                    <div class="control-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="overlayToggleSource" checked>
                            <span>Show Source (Jaw)</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="overlayToggleTarget" checked>
                            <span>Show Target (Face)</span>
                        </label>
                    </div>

                    <!-- Opacity Sliders -->
                    <div class="control-group">
                        <div class="slider-group">
                            <label for="overlaySourceOpacity">Source Opacity</label>
                            <div class="slider-container">
                                <input type="range" id="overlaySourceOpacity" min="0" max="100" value="80"
                                    class="slider">
                                <span id="overlaySourceOpacityValue" class="slider-value">80%</span>
                            </div>
                        </div>

                        <div class="slider-group">
                            <label for="overlayTargetOpacity">Target Opacity</label>
                            <div class="slider-container">
                                <input type="range" id="overlayTargetOpacity" min="0" max="100" value="60"
                                    class="slider">
                                <span id="overlayTargetOpacityValue" class="slider-value">60%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Presets -->
                    <div class="control-group">
                        <label for="overlayCameraPreset">Camera Preset</label>
                        <select id="overlayCameraPreset" class="custom-select">
                            <option value="isometric">Isometric</option>
                            <option value="front">Front View</option>
                            <option value="top">Top View</option>
                            <option value="left">Left View</option>
                            <option value="fitAll">Fit All</option>
                        </select>
                    </div>

                    <!-- Next Step -->
                    <button id="finishRegBtn" class="btn btn-primary">
                        Finish & Save ‚Üí
                    </button>
                </div>
            </aside>

            <!-- Main Viewer Area -->
            <main class="viewer-area">
                <!-- Model Selection & Preview View -->
                <div id="selectionView" class="selection-view">
                    <div class="selection-content">
                        <div class="selection-icon">üìã</div>
                        <h2>Select and Register Models</h2>
                        <p>Choose Source (movable) and Target (fixed) models from the sidebar, then click "Proceed to
                            Overlay Viewer" to see them together</p>
                    </div>
                </div>

                <!-- 3D Overlay Viewer Container (Full Registration) -->
                <div id="viewerContainer" class="viewer-container"
                    style="display: none; width: 100%; height: 100%; position: relative;">
                    <canvas id="registrationViewer" style="display: block; width: 100%; height: 100%;"></canvas>
                </div>

                <!-- Split View Viewer (Source and Target side-by-side) -->
                <div id="splitViewContainer" class="split-view-container"
                    style="display: none; width: 100%; height: 100%;">
                    <div class="split-view-panel">
                        <div class="panel-header">Source Model</div>
                        <canvas id="sourceViewer" class="split-view-canvas"></canvas>
                    </div>
                    <div class="split-view-divider"></div>
                    <div class="split-view-panel">
                        <div class="panel-header">Target Model</div>
                        <canvas id="targetViewer" class="split-view-canvas"></canvas>
                    </div>
                </div>

                <!-- Manual Registration Modal -->
                <div id="manualRegModal" class="modal" style="display: none;">
                    <h3 style="margin-top:0;">Manual Registration (4-point)</h3>
                    <p style="font-size:0.9rem; color:#ccc;">Pick exactly 4 matching landmark pairs on Source and
                        Target. Use the "Enter Pick Mode" button then click on the model.</p>
                    <div style="display:flex; gap:12px; margin-bottom: 16px;">
                        <div style="flex:1;">
                            <h4 style="margin:4px 0">Source Points</h4>
                            <ol id="sourcePointsList"
                                style="max-height:160px; overflow:auto; padding-left:18px; color:#fff; margin: 4px 0;">
                            </ol>
                        </div>
                        <div style="flex:1;">
                            <h4 style="margin:4px 0">Target Points</h4>
                            <ol id="targetPointsList"
                                style="max-height:160px; overflow:auto; padding-left:18px; color:#fff; margin: 4px 0;">
                            </ol>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end; flex-wrap: wrap;">
                        <button id="clearPointsBtn" class="btn btn-secondary">Clear</button>
                        <button id="enterPickModeBtn" class="btn btn-primary">Enter Pick Mode</button>
                        <button id="computeTransformBtn" class="btn btn-success" disabled>OK</button>
                        <button id="closeManualModalBtn" class="btn btn-small">Close</button>
                    </div>
                </div>

                <!-- DICOM 2D Viewer Container -->
                <div id="dicomViewerContainer" class="dicom-viewer-container"
                    style="display: none; width: 100%; height: 100%; position: relative; flex-direction: column;">
                    <div class="dicom-controls">
                        <button id="dicomPrevBtn" class="btn btn-small">‚Üê Previous</button>
                        <span id="dicomSliceInfo" class="dicom-info">Loading...</span>
                        <button id="dicomNextBtn" class="btn btn-small">Next ‚Üí</button>
                        <input type="range" id="dicomSliceSlider" min="0" max="100" value="0" class="dicom-slider"
                            style="flex: 1; margin: 0 10px;">
                    </div>
                    <canvas id="dicomViewer" style="flex: 1; background: #1a1a2e;"></canvas>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading models...</p>
                </div>

                <!-- REG-01.4: UX Improvement - Non-blocking Pick Mode Overlay -->
                <div id="pickModeOverlay" style="display: none;">
                    <div class="pick-status">
                        <span>Source: <span id="sourcePickCount" class="pick-count">0/4</span></span>
                        <div style="width: 1px; height: 16px; background: rgba(255,255,255,0.2);"></div>
                        <span>Target: <span id="targetPickCount" class="pick-count">0/4</span></span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="undoPickBtn" class="btn-finish"
                            style="background: rgba(255, 68, 68, 0.2); border: 1px solid rgba(255, 68, 68, 0.3); color: #ff6666;">Undo</button>
                        <button id="finishPickBtn" class="btn-finish">Finish Picking</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="../js/PLYLoader.js"></script>
    <script src="../js/STLLoader.js"></script>
    <script src="../js/OrbitControls.js"></script>

    <script src="../js/splitViewViewer.js"></script>
    <script src="../js/dicomViewer2D.js"></script>
    <script src="../js/registration-viewer.js?v=4"></script>
    <script src="../js/registration.js?v=4"></script>
</body>

</html>